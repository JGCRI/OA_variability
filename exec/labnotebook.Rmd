---
title: "Ocean pH"
author: "K. Dorheim"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
 html_document:
    toc: TRUE
    toc_float:
      collapsed: true
      toc_depth : 3
---
****

# House Keeping Notes


****

#### New Stuff 


#### To Do List 
* Basin analysis (in progress about half way done) 
* Amplitudes/trends in basins
* Detrend the stuff by model/normalize (in progress trying to determine the methodology)
* Add pCO2 
* Keeling Curve vs. pH (low)
* Model Amplitude - make a summary table for the document and a separate document for all figures
* Break up into Marine Ecological Units ?
* Figure out better way to print (low priority)
* Ocean Data View ? 

#### Next Steps 
* Diagnosis peak 
* Future and past phase shift 
* Signal processing EOF analysis??
* Kanban organization

#### Organization 
* September: basin stuff done
* October: outline/story board
* November: 
* December: no one is here
* Jan: donish finishing touches on stuff
* Feb: Oceans meeting

<!-- 
# Notes to Self 
* CC N86108 
* Email from Corrine on 8/09/2017 
* First project meeting on 08/09/2017 see notebook 1 pg 92 for notes 

# The Done List 
* The first thing Corinne had be do was look into averaging pH over different ocean depths but then it turned out that only the annual ocean data has the ocean depth data so get to skip this step -- see the L1_cmip5_depth.R code
* Figure out how to write as a package... 
-->

```{r markdown environment set up, echo = FALSE, message = FALSE, warning = FALSE}
# -----------------------------------------------------------------------------------------------   
# Setting up the environment, the BASE_NAME dir should be set to the package level. Other scripts/
# commands will depend on the package being the BASE_NAME for other directories. 
# BASE_NAME <- getwd()
BASE_NAME <- "C:/Users/dorh012/Documents/GitHub/OA_variability/OA_variability" 
DO_DIR <- paste0(BASE_NAME, "/exec/processing/")

# load project package
devtools::load_all(BASE_NAME)

# Additional required libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
```


# Methodology 
****

Only the annual data sets for pH, check the other variables has depth information so did not average depth for surface values.

#### L1
1. CDO - Concatenate cmip netcdfs and convert to absolute time 
2. CDO - Get the field weighted mean via cdo 
3. R - Remove model with unrealistic or missing pH/CO3 observations 
4. R - Plot monthly weighted mean

<br>


# 1. pH
***

### Files Processed
****
```{r, echo = FALSE, message = FALSE, warning = FALSE}
source(paste0(DO_DIR,"/exploratory/visualize/ph_fldmean_output_info.R"))
```

#### Monthly pH netcdfs 
Number of files with depth information.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$depth
```

Number summary of the CMIP5 files found on pic vs. the netcdfs processed by the cdo commands.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$table_counts
```

<br>

Summary of the CMIP5 files processed by the cdo commands.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$files_processed$ex_en_table
```
<br>

Unprocessed CMIP5 files 
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$unprocessed_files
```
<br>
<br>


### Exploratory Figures
```{r Generate the exploratory figures for all variables, echo = FALSE, message = FALSE, warning = FALSE}
source(paste0(DO_DIR,"/exploratory/visualize/vis_exploratory_fldmean_all.R"))
```

Important Note: None of this figures include data from the *MRI-ESM1* model, pH is unrealistic. 

### 1. a. Time Series
```{r 1. a. Time Series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10, fig.height=7}
time_series$ph$time_series
```

### 1. b. Mean Monthly pH by Model
```{r 1. b. Mean Monthly, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
fig$global_average_ph_r1i1p1_historical$plots$mean_monthly +
  labs(y = "pH", title =paste0("")) -> p1

fig$global_average_ph_r1i1p1_rcp85$plots$mean_monthly +
  labs(y = "pH", title = paste0("")) -> p2

grid.arrange(p1, p2, ncol = 2)
```

### 1. c. Mean Monthly
```{r 1. c. Mean Monthly, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
fig$global_average_ph_r1i1p1_historical$plots$boxplot$monthly +
  labs(y = "pH", title ="") -> p1

fig$global_average_ph_r1i1p1_rcp85$plots$boxplot$monthly +
  labs(y = "pH", title = "") +
  coord_cartesian(ylim = c(7.5, 8.25)) -> p2

grid.arrange(p1, p2, ncol = 2)
```


## CESM pH figs

### 1. d. CESM pH time series
```{r 1. d. CESM pH time series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_ph_r1i1p1_historical$plots$time_series -> p1
CESM_figs$global_average_ph_r1i1p1_rcp85$plots$time_series -> p2

grid.arrange(p1, p2, ncol = 2)
```

### 1. e. CESM pH monthly time series
```{r 1. e. CESM pH monthly time series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_ph_r1i1p1_historical$plots$mean_monthly -> p1
CESM_figs$global_average_ph_r1i1p1_rcp85$plots$mean_monthly -> p2

grid.arrange(p1, p2, ncol = 2)
```

### 1. f. CESM pH boxplot
```{r 1. f. CESM pH boxplot, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_ph_r1i1p1_historical$plots$boxplot$monthly -> p1
CESM_figs$global_average_ph_r1i1p1_rcp85$plots$boxplot$monthly -> p2

grid.arrange(p1, p2, ncol = 2)
```

<br>
<br>

# 2. CO3
***

### Files Processed
****
```{r, echo = FALSE, message = FALSE, warning = FALSE}
source(paste0(DO_DIR,"/exploratory/visualize/co3_fldmean_output_info.R"))
```

#### Monthly CO3 netcdfs
Number of files with depth information.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$depth
```

Number summary of the CMIP5 files found on pic vs. the netcdfs processed by the cdo commands.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$table_counts
```
<br>


Summary of the CMIP5 files processed by the cdo commands.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$files_processed$ex_en_table
```
<br>

Unprocessed CMIP5 files 
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$unprocessed_files
```
<br>
<br>

### Exploratory Figures

### 2. a. Time Series 
```{r 2. a. Time Series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
time_series$co3$time_series
```

### 2. b. Mean Monthly CO3 by Model
```{r 2. b. Mean Monthly, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
fig$global_average_co3_r1i1p1_historical$plots$mean_monthly + 
  labs(title =paste0("")) -> p1

fig$global_average_co3_r1i1p1_rcp85$plots$mean_monthly +
  labs(title = paste0("")) -> p2

grid.arrange(p1, p2, ncol = 2)
```

### 2. c. Mean Monthly 
```{r 2. c. Mean Monthly, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
fig$global_average_co3_r1i1p1_historical$plots$boxplot$monthly + 
  labs(title ="") -> p1

fig$global_average_co3_r1i1p1_rcp85$plots$boxplot$monthly +
  labs(title = "") -> p2

grid.arrange(p1, p2, ncol = 2)
```

## CESM CO3 figs

### 2. d. CESM CO3 time series
```{r 2. d. CESM pH time series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_co3_r1i1p1_historical$plots$time_series -> p1 
CESM_figs$global_average_co3_r1i1p1_rcp85$plots$time_series -> p2 

grid.arrange(p1, p2, ncol = 2)
```

### 2. e. CESM CO3 monthly time series
```{r 2. e. CESM pH monthly time series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_co3_r1i1p1_historical$plots$mean_monthly -> p1 
CESM_figs$global_average_co3_r1i1p1_rcp85$plots$mean_monthly -> p2 

grid.arrange(p1, p2, ncol = 2)
```

### 2. f. CESM CO3 boxplot
```{r 2. f. CESM pH boxplot, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_co3_r1i1p1_historical$plots$boxplot$monthly -> p1 
CESM_figs$global_average_co3_r1i1p1_rcp85$plots$boxplot$monthly -> p2 

grid.arrange(p1, p2, ncol = 2)
```


<br>
<br>

# 3. tos
***

### Files Processed
****
```{r, echo = FALSE, message = FALSE, warning = FALSE}
source(paste0(DO_DIR,"/exploratory/visualize/tos_fldmean_output_info.R"))
```

#### Monthly tos netcdfs
Number of files with depth information.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$depth
```

Number summary of the CMIP5 files found on pic vs. the netcdfs processed by the cdo commands.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$table_counts
```
<br>


Summary of the CMIP5 files processed by the cdo commands.
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$files_processed$ex_en_table
```
<br>

Unprocessed CMIP5 files 
```{r, echo = FALSE, message = FALSE, warning = FALSE}
out$unprocessed_files
```
<br>
<br>

### Exploratory Figures

### 3. a. Time Series
```{r 3. a. Time Series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
time_series$tos$time_series 
```

### 3. b. Mean Monthly tos by Model
```{r 3. b. Mean Monthly, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
fig$global_average_tos_r1i1p1_historical$plots$mean_monthly + 
  labs(title = paste0("")) -> p1

fig$global_average_tos_r1i1p1_rcp85$plots$mean_monthly +
  labs(title = paste0("")) -> p2

grid.arrange(p1, p2, ncol = 2)
```

### 3. c. Mean Monthly 
```{r 3. c. Mean Monthly, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
fig$global_average_tos_r1i1p1_historical$plots$boxplot$monthly +
  labs(title ="") -> p1

fig$global_average_tos_r1i1p1_rcp85$plots$boxplot$monthly + 
  labs(title = "") -> p2

grid.arrange(p1, p2, ncol = 2)
```

## CESM tos figs

### 3. d. CESM tos time series
```{r 3. d. CESM pH time series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_tos_r1i1p1_historical$plots$time_series -> p1 
CESM_figs$global_average_tos_r1i1p1_rcp85$plots$time_series -> p2 

grid.arrange(p1, p2, ncol = 2)
```

### 3. e. CESM tos monthly time series
```{r 3. e. CESM pH monthly time series, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_tos_r1i1p1_historical$plots$mean_monthly -> p1 
CESM_figs$global_average_tos_r1i1p1_rcp85$plots$mean_monthly -> p2 

grid.arrange(p1, p2, ncol = 2)
```

### 3. f. CESM tos boxplot
```{r 3. f. CESM pH boxplot, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
CESM_figs$global_average_tos_r1i1p1_historical$plots$boxplot$monthly -> p1 
CESM_figs$global_average_tos_r1i1p1_rcp85$plots$boxplot$monthly -> p2 

grid.arrange(p1, p2, ncol = 2)
```

<br>
<br>

# 4. CESM Monthly Mean and Amplitude
***
```{r generate section 4 figures, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
source(paste0(DO_DIR, "/exploratory/visualize/CESM_investigation_oceans_conference.R"))
```


### 4. a. Monthly Mean pH 
```{r 4. a. Monthly Mean pH, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
p1 <- out$historical$figs$mean$ph$fig 
p2 <- out$rcp85$figs$mean$ph$fig

grid.arrange(p1, p2, ncol = 2)
```

### 4. b. Monthly Amplitude pH 
```{r 4. b. Monthly Amplitude pH , echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
p1 <- out$historical$figs$range$ph$fig 
p2 <- out$rcp85$figs$range$ph$fig

grid.arrange(p1, p2, ncol = 2)
```

Amplitude mean and sd table

```{r, echo = FALSE}
out$historical$tab$range$ph 
out$rcp85$tab$range$ph
```

<br>
<br>

### 4. c. Monthly Mean CO3
```{r 4. c. Monthly Mean CO3, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
p1 <- out$historical$figs$mean$co3$fig 
p2 <- out$rcp85$figs$mean$co3$fig

grid.arrange(p1, p2, ncol = 2)
```

### 4. d. Monthly Amplitude CO3
```{r 4. d. Monthly Amplitude CO3, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
p1 <- out$historical$figs$range$co3$fig 
p2 <- out$rcp85$figs$range$co3$fig

grid.arrange(p1, p2, ncol = 2)
```

Amplitude mean and sd table

```{r, echo = FALSE}
out$historical$tab$range$co3 
out$rcp85$tab$range$co3
```

<br>
<br>

### 4. e. Monthly Mean tos
```{r 4. e. Monthly Mean tos, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
p1 <- out$historical$figs$mean$tos$fig 
p2 <- out$rcp85$figs$mean$tos$fig

grid.arrange(p1, p2, ncol = 2)
```

### 4. f. Monthly Amplitude tos
```{r 4. f. Monthly Amplitude tos, echo = FALSE, message = FALSE, warning = FALSE, fig.width=10}
p1 <- out$historical$figs$range$tos$fig 
p2 <- out$rcp85$figs$range$tos$fig

grid.arrange(p1, p2, ncol = 2)
```

Amplitude mean and sd table

```{r, echo = FALSE}
out$historical$tab$range$tos
out$rcp85$tab$range$tos
```

<br> <br>

# 5. Linear Trends
```{r, echo = FALSE, warning = FALSE, message = FALSE}
source(paste0(DO_DIR, "/L2/determine_trends.R"))
```

I calculated the "trend" for each model/experiment combination for each variable as the slope from a simple linear regression. For each linear regression I also have normal quantile, histogram of residuals, & residuals vs. fitted plots.

### Tables

Table of counts for the non-0 linear trends.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10, fig.height=7}
out$table$trend
```


Table of counts of trends with significant p values (p <= 0.005)

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10, fig.height=7}
out$table$pval
```


### 5. a. Annual Normalized Slope Box Plot 
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10, fig.height=7}
out$figures$annual_slope
```


### 5. b. Monthly Normalized Slope Box Plots
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10, fig.height=7}
out$figures$monthly_slope$ph
out$figures$monthly_slope$co3
out$figures$monthly_slope$tos
```

 
The End
